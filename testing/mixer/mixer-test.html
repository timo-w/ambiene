<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web Audio API - Volume Control</title>
<style>
    .slider-container {
        margin-bottom: 20px;
    }
    input[type="range"] {
        width: 100%;
    }
</style>
</head>

<body>
<h1>Web Audio API - Mixing Test</h1>

<div class="slider-container">
    <label for="toggle-playback">Play/Pause:</label>
	<input id="toggle-playback" type="button" onclick="ambienceTrack.toggle();" value="Play/Pause">
</div>

<div class="slider-container">
    <label for="click">Button click test:</label>
	<input id="click" type="button" onclick="uiTrack.soundButton();" value="Click">
	<label for="notch">Notch test:</label>
	<input id="notch" type="button" onclick="uiTrack.soundNotch();" value="Click">
</div>

<div class="slider-container">
    <label for="bird-slider">Birds:</label>
	<input id="bird-slider" type="range" min="0" max="100" value="0" oninput="ambienceTrack.setBirds(this);">
</div>

<div class="slider-container">
    <label for="bird-slider">Fire:</label>
	<input id="bird-slider" type="range" min="0" max="100" value="0" oninput="ambienceTrack.setFire(this);">
</div>

<div class="slider-container">
    <label for="bird-slider">Wind:</label>
	<input id="bird-slider" type="range" min="0" max="100" value="0" oninput="ambienceTrack.setWind(this);">
</div>

<div class="slider-container">
    <label for="bird-slider">Rain:</label>
	<input id="bird-slider" type="range" min="0" max="100" value="0" oninput="ambienceTrack.setRain(this);">
</div>

<div class="slider-container">
    <label for="shop-slider">Coffee Shop:</label>
	<input id="shop-slider" type="range" min="0" max="100" value="0" oninput="ambienceTrack.setShop(this);">
</div>

<div class="slider-container">
    <label for="lowpass-slider">Low-pass Filter:</label>
	<input id="lowpass-slider" type="range" min="2000" max="20000" value="0" oninput="ambienceTrack.setLowpass(this);">
</div>

<script>


context = new (window.AudioContext || window.webkitAudioContext)();

function playSound(buffer, time) {
  var source = context.createBufferSource();
  source.buffer = buffer;
  source.connect(context.destination);
  source[source.start ? 'start' : 'noteOn'](time);
}

function loadSounds(obj, soundMap, callback) {
  var names = [];
  var paths = [];
  for (var name in soundMap) {
    var path = soundMap[name];
    names.push(name);
    paths.push(path);
  }
  bufferLoader = new BufferLoader(context, paths, function(bufferList) {
    for (var i = 0; i < bufferList.length; i++) {
      var buffer = bufferList[i];
      var name = names[i];
      obj[name] = buffer;
    }
    if (callback) {
      callback();
    }
  });
  bufferLoader.load();
}


function BufferLoader(context, urlList, callback) {
  this.context = context;
  this.urlList = urlList;
  this.onload = callback;
  this.bufferList = new Array();
  this.loadCount = 0;
}

BufferLoader.prototype.loadBuffer = function(url, index) {
  // Load buffer asynchronously
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  var loader = this;

  request.onload = function() {
    // Asynchronously decode the audio file data in request.response
    loader.context.decodeAudioData(
      request.response,
      function(buffer) {
        if (!buffer) {
          alert('error decoding file data: ' + url);
          return;
        }
        loader.bufferList[index] = buffer;
        if (++loader.loadCount == loader.urlList.length)
          loader.onload(loader.bufferList);
      },
      function(error) {
        console.error('decodeAudioData error', error);
      }
    );
  }

  request.onerror = function() {
    alert('BufferLoader: XHR error');
  }

  request.send();
};

BufferLoader.prototype.load = function() {
  for (var i = 0; i < this.urlList.length; ++i)
  this.loadBuffer(this.urlList[i], i);
};

function createSource(buffer) {
    var source = context.createBufferSource();
    var gainNode = context.createGain();
	var filter = context.createBiquadFilter();
    source.buffer = buffer;
    // Turn on looping
    source.loop = true;
    // Connect source to gain.
    source.connect(gainNode);
	// Connect gain to filter
	gainNode.connect(filter);
    // Connect filter to destination.
    filter.connect(context.destination);
	
	// Set low-pass filter
	filter.type = 'lowpass';
	filter.frequency.setTargetAtTime(20000, context.currentTime, 0);

    return {
      source: source,
      gainNode: gainNode
    };
  }



var Ambience = function() {
  loadSounds(this, {
    birds: 'birds.mp3',
    fire: 'fire.mp3',
	rain: 'rain.mp3',
	wind: 'wind.mp3',
	shop: 'shop.mp3',
  });
  this.isPlaying = false;
}

Ambience.prototype.play = function() {
  // Create sources
  this.ctlbirds = createSource(this.birds);
  this.ctlfire = createSource(this.fire);
  this.ctlwind = createSource(this.wind);
  this.ctlrain = createSource(this.rain);
  this.ctlshop = createSource(this.shop);
  // Set initial gain
  this.ctlbirds.gainNode.gain.value = 0;
  this.ctlfire.gainNode.gain.value = 0;
  this.ctlwind.gainNode.gain.value = 0;
  this.ctlrain.gainNode.gain.value = 0;
  this.ctlshop.gainNode.gain.value = 0;
  // Start playback in a loop
  var onName = this.ctlbirds.source.start ? 'start' : 'noteOn';
  this.ctlbirds.source[onName](0);
  this.ctlfire.source[onName](0);
  this.ctlwind.source[onName](0);
  this.ctlrain.source[onName](0);
  this.ctlshop.source[onName](0);
};


Ambience.prototype.stop = function() {
  var offName = this.ctlbirds.source.stop ? 'stop' : 'noteOff';
  this.ctlbirds.source[offName](0);
  this.ctlfire.source[offName](0);
  this.ctlrain.source[offName](0);
  this.ctlwind.source[offName](0);
  this.ctlshop.source[offName](0);
};

Ambience.prototype.toggle = function() {
  this.isPlaying ? this.stop() : this.play();
  this.isPlaying = !this.isPlaying;
};


Ambience.prototype.setBirds = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlbirds.gainNode.gain.value = x;
};
Ambience.prototype.setFire = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlfire.gainNode.gain.value = x;
};
Ambience.prototype.setWind = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlwind.gainNode.gain.value = x;
};
Ambience.prototype.setRain = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlrain.gainNode.gain.value = x;
};
Ambience.prototype.setShop = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlshop.gainNode.gain.value = x*10;
};

Ambience.prototype.setLowpass = function(element) {
	var x = parseInt(element.value) / parseInt(element.max);
	this.ctlbirds.filter.frequency.value = x;
};




var UI = function() {
  loadSounds(this, {
    button: 'button.mp3',
    notch: 'notch.mp3'
  });
  this.isPlaying = false;
  this.ctlnotch = createSource(this.notch);
  this.ctlnotch.gainNode.gain.value = 0.5;
}

UI.prototype.soundButton = function() {
	this.ctlbutton = createSource(this.button);
	this.ctlbutton.gainNode.gain.value = 0.5;
	this.ctlbutton.source.loop = false;
	var onName = this.ctlbutton.source.start ? 'start' : 'noteOn';
	this.ctlbutton.source[onName](0);
}

UI.prototype.soundNotch = function() {
	this.ctlnotch = createSource(this.notch);
	this.ctlnotch.gainNode.gain.value = 0.5;
	this.ctlnotch.source.loop = false;
	var onName = this.ctlnotch.source.start ? 'start' : 'noteOn';
	this.ctlnotch.source[onName](0);
}


var ambienceTrack = new Ambience();
var uiTrack = new UI();



</script>
</body>
</html>